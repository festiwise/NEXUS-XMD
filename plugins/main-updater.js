const{cmd}=require("../command");constaxios=require('axios');constfs=require('fs');constpath=require("path");constAdmZip=require("adm-zip");const{setCommitHash,getCommitHash}=require('../data/updateDB');cmd({pattern:"update",alias:["upgrade","sync"],react:'üÜï',desc:"Updatethebottothelatestversion.",category:"misc",filename:__filename},async(client,message,args,{reply,isOwner})=>{if(!isOwner)returnreply("Thiscommandisonlyforthebotowner.");try{awaitreply("üîçCheckingforNEXUS-XMDupdates...");//FetchthelatestcommithashfromGitHubconst{data:commitData}=awaitaxios.get("https://github.com/mrtech0135/NEXUSXMD/commits/main");constlatestCommitHash=commitData.sha;//GetthestoredcommithashfromthedatabaseconstcurrentHash=awaitgetCommitHash();if(latestCommitHash===currentHash){returnreply("‚úÖYourNEXUS-XMDbotisalreadyup-to-date!");}awaitreply("üöÄUpdatingNEXUS-XMDBot...");//DownloadthelatestcodeconstzipPath=path.join(__dirname,"latest.zip");const{data:zipData}=awaitaxios.get("https://github.com/mrtech0135/NEXUSXMD/archive/main.zip",{responseType:"arraybuffer"});fs.writeFileSync(zipPath,zipData);//ExtractZIPfileawaitreply("üì¶Extractingthelatestcode...");constextractPath=path.join(__dirname,'latest');constzip=newAdmZip(zipPath);zip.extractAllTo(extractPath,true);//Copyupdatedfiles,preservingconfig.jsandapp.jsonawaitreply("üîÑReplacingfiles...");constsourcePath=path.join(extractPath,"NEXUSXMD-main");constdestinationPath=path.join(__dirname,'..');copyFolderSync(sourcePath,destinationPath);//SavethelatestcommithashtothedatabaseawaitsetCommitHash(latestCommitHash);//Cleanupfs.unlinkSync(zipPath);fs.rmSync(extractPath,{recursive:true,force:true});awaitreply("‚úÖUpdatecomplete!Restartingthebot...");process.exit(0);}catch(error){console.error("Updateerror:",error);returnreply("‚ùåUpdatefailed.Pleasetrymanually.");}});//Helperfunctiontocopydirectorieswhilepreservingconfig.jsandapp.jsonfunctioncopyFolderSync(source,target){if(!fs.existsSync(target)){fs.mkdirSync(target,{recursive:true});}constitems=fs.readdirSync(source);for(constitemofitems){constsrcPath=path.join(source,item);constdestPath=path.join(target,item);//Skipconfig.jsandapp.jsonif(item==="config.js"||item==="app.json"){console.log(`Skipping${item}topreservecustomsettings.`);continue;}if(fs.lstatSync(srcPath).isDirectory()){copyFolderSync(srcPath,destPath);}else{fs.copyFileSync(srcPath,destPath);}}}